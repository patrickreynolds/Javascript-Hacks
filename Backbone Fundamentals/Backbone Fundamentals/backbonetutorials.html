<!DOCTYPE html>
<html>
	<head>
		<title>Backbone JS</title>
		<meta charset="utf-8">
		<link   type="text/css" rel="stylesheet" href="../global/lib/bootstrap-3.1.1/css/bootstrap.min.css">
	</head>
	<body>

		<div class="container">
			<h1>User Manager</h1>
			<hr />
			<div class="page"></div>
		</div>

		<script type="text/template" id="user-list-template">
		<a href="#new" class="btn btn-primary">New User</a>
		<table class="table striped">
			<thead>
				<tr>
					<th>First Name</th>
					<th>Last Name</th>
					<th>Age</th>
					<th></th>
				</tr>
			</thead>
			<tbody>
				<% _.each(users, function(user){ %>
					<tr>
						<td><%- user.get('firstname') %></td>
						<td><%- user.get('lastname') %></td>
						<td><%- user.get('age') %></td>
						<td><a href="#/edit/<%= user.id %>" class="btn btn-default">Edit</a></td>
					</tr>
				<% }); %>
			</tbody>
		</script>

		<script type="text/template" id="edit-user-template">
		<div class="row">
			<div class="form-container col-sm-6">
				<form class="edit-user-form" role="form">
					<legend><%- user ? 'Update' : 'Create' %> User</legend>
					<div class="form-group col-sm-12">
						<label>First Name</label>
						<input type="text" class="form-control" name="firstname" value="<%= user ? user.get('firstname') : '' %>" />
					</div>
					<div class="form-group col-sm-12">
						<label>Last Name</label>
						<input type="text" class="form-control" name="lastname" value="<%= user ? user.get('lastname') : '' %>" />
					</div>
					<div class="form-group col-sm-12">
						<label>Age</label>
						<input type="text" class="form-control" name="age" value="<%= user ? user.get('age') : '' %>"/>
					</div>
					<hr />

					<button type="submit" class="btn"><%- user ? 'Update' : 'Create' %></button>
					<% if(user) { %>
						<input type="hidden" name="id" value="<%= user.id %>" />
						<button type="button" class="btn btn-danger delete">Delete</button>
					<% }; %>
				</form>
			<div>
		</div>
		</script>

		<script type="text/javascript" src="../global/lib/jquery.min.js"></script>
		<script type="text/javascript" src="../global/lib/underscore-min.js"></script>
		<script type="text/javascript" src="../global/lib/backbone-min.js"></script>
		<script type="text/javascript" src="../global/lib/backbone.localStorage.js"></script>
		<script type="text/javascript" src="../global/lib/backbone.marionette.js"></script>
		<script type="text/javascript" src="../global/lib/bootstrap-3.1.1/js/bootstrap.min.js"></script>

		<script type="text/javascript">

		// API query prefilter
		$.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
      		options.url = 'http://backbonejs-beginner.herokuapp.com' + options.url;
    	});

	    $.fn.serializeObject = function() {
	      var o = {};
	      var a = this.serializeArray();
	      $.each(a, function() {
	          if (o[this.name] !== undefined) {
	              if (!o[this.name].push) {
	                  o[this.name] = [o[this.name]];
	              }
	              o[this.name].push(this.value || '');
	          } else {
	              o[this.name] = this.value || '';
	          }
	      });
	      return o;
	    };

		// ======== Collection ======== 
		var Users = Backbone.Collection.extend({
			url: '/users'
		});

		// ======== Models ========
		var User = Backbone.Model.extend({
			urlRoot: '/users'

			// PUT /users/1
			// DELETE /users/1
			// /users
		});

		// ======== Views ========
		var UserList = Backbone.View.extend({
			el: '.page',
			render: function () {
				var that = this;
				var users = new Users();
				users.fetch({
					success: function (users) {
						var template = _.template($('#user-list-template').html(), {users: users.models});
						that.$el.html(template);
					}
				});
			}
		});

		var EditUser = Backbone.View.extend({
			el: '.page',
			render: function (options) {
				var that = this;
				if (options.id) {
					// GET request
					that.user = new User({id: options.id});
					that.user.fetch({
						success: function (user) {
							var template = _.template($('#edit-user-template').html(), {user: user});
							that.$el.html(template);
						}
					});
				} else {
					var template = _.template($('#edit-user-template').html(), {user: null});
					this.$el.html(template);
				}
			},
			events: {
				'submit .edit-user-form': 'saveUser',
				'click .delete': 'deleteUser'
			},
			saveUser: function (ev) {
				var userDetails = $(ev.currentTarget).serializeObject();
				var user = new User();
				user.save(userDetails, {
					success: function (user) {
						console.log(userDetails);
						router.navigate('', {trigger: true});
					}
				});
				return false;
			},

			deleteUser: function (ev) {
				// DELETE /users/id
				this.user.destroy({
					success: function () {
						router.navigate('', {trigger: true});
					}
				});
				return false;
			}
		});

		// ======== Routers ========
		var Router = Backbone.Router.extend({
			routes: {
				'': 'home',
				'new': 'editUser',
				'edit/:id': 'editUser'
			}
		});

		var userList = new UserList();
		var editUser = new EditUser();
		var router = new Router();

		router.on('route:home', function (){
			userList.render();
		});

		router.on('route:editUser', function (id){
			editUser.render({id: id});
		});

		// ======== Histroy ======== 
		Backbone.history.start();

		</script>
	</body>
</html>


