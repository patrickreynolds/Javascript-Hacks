<!DOCTYPE html>
<html>
	<head>
		<title>Chapter 2</title>
		<script type="text/javascript" src="../global/lib/jquery.min.js"></script>
		<script type="text/javascript" src="../global/lib/underscore-min.js"></script>
		<script type="text/javascript" src="../global/lib/backbone-min.js"></script>
		<script type="text/javascript" src="../global/lib/backbone.localStorage.js"></script>
		<script type="text/javascript" src="../global/lib/backbone.marionette.js"></script>
		<script type="text/javascript" src="../global/lib/bootstrap-3.1.1/js/bootstrap.min.js"></script>
		<link   type="text/css" rel="stylesheet" href="../global/lib/bootstrap-3.1.1/css/bootstrap.min.css">
	</head>
	<body>
		
		<!-- Layout manager template -->
		<script type="text/template" id="tpl_main_content">
		  <div id="main_content">
		    <div class="user-list"></div>
		    <div class="user-details"></div>
		  </div>
		</script>

		<!-- User item template -->
		<script type="text/template" id="tpl_user_item">
		  <a class="name" href="#">{{name}}</a>
		</script>

		<!-- User details template -->
		<script type="text/template" id="tpl_user_details">
		  <div class="avatar"><img src="{{avatar}}" /></div>
		    <ul>
		      <li><strong>Name:</strong>  {{name}}</li>
		      <li><strong>Email:</strong>  {{email}}</li>
		      <li><strong>Phone:</strong>  {{phone}}</li>
		      <li><strong>Twitter:</strong>  {{twitter}}</li>
		    </ul>
		</script>

		<script type="text/javascript">
		/*
			// ---- Model Declarations ----
			var User = Backbone.Model.extend({});


			// ---- Collection Declarations ----
			var Users = Backbone.Collection.extend({
			  model: User
			});

			var users = new Users([{
			  id: 1,
			  name: 'John Doe'
			}, {
			  id: 2,
			  name: 'Dan Smith'
			}]);


			// ---- View Declarations ----
			var ParentView = Backbone.View.extend({
			  	initialize: function () {
			    	this.subViews = []; 
			   
			   	// Initializing the child views
			    	this.subViews.push(new ChildView(), new ChildView());
			  	},

			  	render: function () {
			    	this.$el.html(this.template);

			  			// Render each child view
			    		_(this.subViews).each(function (view) {
			      		this.$el.append(view.render().el);
			    	}, this);

			    	return this;
			  	}
			});


			var UserItemView = Backbone.View.extend({
			  tagName: 'li',
			  template: _.template( '<%= name %>'),
			  events: {
			    'click': 'showUserName',
			    'dblclick': 'alertUserName'
			  },
			  render: function () {
			    var html = this.template(this.model.toJSON());
			    this.$el.html(html);
			    return this;
			  },

			  showUserName: function () {
			    console.log('Clicked user\'s name: ' + this.model.get('name'));
			  },

			  alertUserName: function() {
			  	alert('Clicked user\'s name: ' + this.model.get('name'));
			  }
			});

			var UsersView = Backbone.View.extend({
				tagName: 'ul',

				render: function () {
					// create a document fragment
					var fragment = document.createDocumentFragment();

					this.collection.each(function (model) {
						// add each view element to the document fragment
						fragment.appendChild(new UserItemView({
							model: model
						}).render().el);
					}, this);

					// append the fragment to the DOM
					this.$el.html(fragment);
					return this;
				},

				events: {
					//'click li': 'alertUserName',
				},
			});

			var usersView = new UsersView({
				// add the collection instance
				collection: users
			});

			$(document.body).append(usersView.render().el);
			*/

			// Change template delimiter to Mustache type
			_.templateSettings = {
			  interpolate: /\{\{(.+?)\}\}/g
			};

			// User Model
			var User = Backbone.Model.extend({
			  defaults: {
			    avatar: '',
			    name: '',
			    email: '',
			    phone: '',
			    twitter: ''
			  }
			});

			// Users collection
			var Users = Backbone.Collection.extend({
			  model: User
			});

			// UserItem sub view
			var UserItem = Backbone.View.extend({
			  	tagName: 'li',
			  	template: '#tpl_user_item',
			  	manage: true,

			  	// LayoutManager uses serialize method to apply the data into template
			  	serialize: function () {
			    	return this.model.toJSON();
			  	},

			  	events: {
					'click a': 'showDetails'
				},

				showDetails: function () {
					// Check Whether details view exists
					var detailsView = mainLayout.getView('.user-details');

					// If details view doesn't exist, create one, 
					// set the new model and render it
					if (!detailsView) {
				  		mainLayout.setView('.user-details', new UserDetails().setModel(this.model).render());
					} else {
				  		// Set the latest clicked model and re-render
				  		detailsView.setModel(this.model).render();
					}
				}
			});

			// User List view
			var UserList = Backbone.View.extend({
			  tagName: 'ul',
			  className: 'nav nav-tabs nav-stacked',
			  manage: true,

			  // Before rendering the list, 
			  //insert all the child list items into it
			  beforeRender: function () {
			    this.collection.each(function (model) {
			      // insertview method inserts the views 
			      // directly inside the parent view
			      this.insertView(new UserItem({
			        model: model
			      }));
			    }, this);
			  }
			}); 

			// Create a collection with some data
			var users = new Users([{
			  name: 'John Doe',
			  avatar: 'avatar.png',
			  phone: '+88-888-8888',
			  twitter: 'johndoe',
			  email: 'johndoe@example.com'
			}, {
			  name: 'Swarnendu De',
			  avatar: 'avatar.png',
			  phone: '+99-999-9999',
			  twitter: 'swarnendude',
			  email: 'swarnendude@example.com'
			}]);

			// Define the main layout
			var MainLayout = Backbone.Layout.extend({
			  template: "#tpl_main_content",

			  // Assign the view to specific selectors
			  views: {
			    '.user-list': new UserList({
			      collection: users
			    })
			  }
			});

			// User Details view
			var UserDetails = Backbone.View.extend({
			  manage: true,
			  template: '#tpl_user_details',

			  serialize: function () {
			    return this.model.toJSON();
			  },

			  // Set the selected model 
			  setModel: function (model) {
			    if (model) {
			      this.model = model;
			    }

			    return this;
			  }
			}); 

		</script>
	</body>
</html>


